---
title: "Clusterização hierárquica para determinação do número ótimo de clusters para classificação de deputados federais como bancada evangélica"
subtitle: 'DOCUMENTO: SAR-2021-011-JG-v01'
author: '**De:** Felipe Figueiredo **Para:** Josir Gomes'
date: '**Data:** 2021-10-12'
output:
  html_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    keep_md: yes
    number_sections: yes
    toc: yes
  pdf_document:
    number_sections: yes
    toc: yes
  word_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    reference_docx: misc/style_SAR_pt.docx
    toc: yes
toc-title: "Sumário"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
options(scipen = 999)
library(pander)
library(knitr)
library(philsfmisc)
panderOptions('table.style', 'rmarkdown')
panderOptions('table.split.table', 160)
```

---

**Histórico do documento**

```{r history}
Version <- c("01")
Changes <- c("Versão inicial")
history <- cbind(Version, Changes)
colnames(history) <- c("Versão", "Alterações")
# pander(history, split.cells = 70)
kable(history)
```

---

# Lista de abreviaturas

- BSS:
- TSS:
- WSS:

# Introdução

Avaliação da qualidade do agrupamento de acordo com dois critérios: altura da árvore e número putativo de clusters.
Criação do elbow plot para auxiliar a tomada de decisão no uso do kmeans.

Esta análise testou a hipótese de que
deputados federais evangélicos que foram eleitos em 2018 podem ser identificados com base nas doações recebidas durante a campanha eleitoral, número de votos recebidos e outras características.

O posicionamento político dos deputados foi identificado pelo índice de Power e Silveira-Rodrigues que varia de -1 a 1, onde -1 é mais à esquerda e 1 mais à direita.

A capilaridade é um índice de 0 a 1 que indica quão ampla (sob o ponto de vista geográfico) foi a votação do candidato.
Quanto maior o número de zonas eleitorais onde o candidato recebeu votos, maior o índice.
Este indicador é a média dos percentis de cada zona eleitoral em que o candidato concorreu.

A classificação dos deputados como pertencendo ou à classe evangélica foi estabelecida por autodenominação, isto é, foram considerados evangélicos os deputados que se autodenominaram como tal.

## Objetivos

1. Avaliar número ideal de clusters de acordo em um dendograma de clusterização hierárquica, para uso do kmeans.
1. Avaliar em particular a acurácia do agrupamento aplicado em 2 clusters com a proposta de identificar os deputados da bancada evangélica vs outros, de acordo com a classificação pré estabelecida.

## Recepção e tratamento dos dados

Base de dados recebida contendo características dos deputados federais eleitos em 2018.
Todas as variáveis da tabela de dados analíticos foram identificadas de acordo com as descrições das variáveis, e os valores foram identificados de acordo com o dicionário de dados providenciado.
Estas identificações possibilitarão a criação de tabelas de resultados com qualidade de produção final.

Foram feitos ajustes de escala em variáveis para viabilizar a performance dos algoritmos, mantendo a interpretabilidade dos dados.
O número de votos, o número de filiados do partido foram padronizados por milhão e todas as variáveis relativas às receitas foram padronizados em milhões de reais -- com estas novas escalas todas as variáveis da base tiveram suas amplitudes reduzidas entre 0 e 2.5.
O posicionamento foi mantido em sua escala original por já ter amplitude de tamanho 2 (entre -1 e 1).

Uma observação não tinha o número de votos registrada, e foi removida para a análise de clusters.

# Metodologia

```{r results, include=FALSE}
source("scripts/results.R", encoding = 'UTF-8')
```

## Variáveis

### Desfechos primário e secundário

O desfecho primário está definido como o número ótimo de clusters para uso no algoritmo k-means.
O número de clusters foi definido de acordo com a largura média da silhueta no agrupamento hierárquico.

O desfecho secundário é a avaliação do k-means com dois clusters (k=2) para a classificação entre deputados da bancada evangélica e outros deputados explicada pela receita total recebida.

### Covariáveis

As seguintes características dos deputados federais foram consideradas para inclusão na análise: Número de votos recebidos, posicionamento político, capilaridade, a unidade da federação, o partido (sigla), o sexo e se é o primeiro mandato.
As seguintes características dos partidos foram consideradas para inclusão na análise:  decil do número de deputados eleitos e decil do número de filiados.

As receitas discriminadas em suas diversas origens não foram consideradas na análise principal, devido à baixa representatividade de valores em suas distribuições (figura A1).
O impacto da exclusão destas variáveis nos clusters foi avaliada em uma análise de sensibilidade.

## Análises Realizadas

As características dos deputados foram descritas, por estado, como
média (DP)
<!-- mediana (IIQ) -->
ou frequência e proporção (%),
conforme apropriado.
As distribuições foram sumarizadas em tabelas e visualizadas em gráficos exploratórios.

O agrupamento hierárquico foi realizado usando a distância euclidiana e o critério de ligação completa (*complete linkage*).
O agrupamento hierárquico foi avaliado pelo método da silhueta, onde as larguras das silhuetas de cada observação são calculadas individualmente resultando em uma medida interpretável do pertencimento ao cluster avaliado.
Valores positivos de silhueta indicam um bom ajuste da observação ao cluster.
A média das larguras das silhuetas foi calculada como critério de avaliação global do agrupamento hierárquico.

Após a determinação do número ótimo de clusters, dois agrupamentos k-means foram realizados para diagnóstico usando a distância euclidiana e 10 centroides iniciais aleatórios -- o primeiro usando o número ótimo de clusters conforme determinado pelo agrupamento hierárquico (desfecho primário) e o segundo usando dois clusters (desfecho secundário).
O agrupamento do k-means foi avaliado com o WSS total e foi apresentada a proporção da variância explicada pelo agrupamento.
Esta proporção foi calculada como $\text{variância explicada} = \frac{BSS}{TSS} \times 100$.

### Softwares utilizados

Esta análise foi realizada utilizando-se o software `R` versão `r getRversion()`.

# Resultados

## Análise descritiva
<!-- dados da tabela adhoc em describe.R -->
Em 2018 foram eleitos 116 (23% dos deputados avaliados) deputados federais que se autodenominaram evangélicos.
Destes,
29 (25%) estão filiados à igreja AD,
21 (18%) à igreja IURD e
15 (13%) à igreja Batista.
Observa-se nas duas classes de deputados federais uma predominância do sexo masculino, com
91 (78%) homens entre os deputados evangélicos e
345 (87%) homens dentre as demais classes
(Tabela 1).
O deputado federal evangélico parece ter posicionamento político mais alinhado à direita, com índice de Power e Silveira-Rodrigues médio 0.7.

A maior parte dos deputados federais eleitos em 2018 foram eleitos em primeiro mandato.
Dentro os deputados evangélicos
94 (81%) se elegeram pela primeira vez e
22 (19%) foram reeleitos.
Os candidatos evangélicos obtiveram, na média, 127 mil votos,
quando os outros deputados obtiveram 97 mil votos.
Apesar da discrepância nas médias de performance de votos, a variabilidade deste indicador é substancialmente maior na classe de deputados evangélicos, com desvio padrão superior à média.
A variabilidade entre os dois grupos pode ser comparada pelo CV -- o CV dos deputados evangélicos foi 157% enquanto nos outros foi 60%.
Ambos os grupos tiveram capilaridade semelhante, em torno de 0.8 na média.

Os partidos tiveram desempenho comparáveis, onde tanto
o decil do número de deputados eleitos como
o decil do número de filiados
ficaram na faixa entre 0,7 e 0,8 (Tabela 1).
Os partidos que mais abrigaram os deputados evangélicos eleitos foram o
PRB com	23 (20%) deputados,
PSL com	16 (14%),
PR com	10 (8.6%) e
os partidos com menor representatividade desta classe foram
PATRIOTA,
PMN,
PRP e
PTC
todos com 1 (0.9%) deputado.

```{r tab_desc}
tab_desc %>%
    as_kable(
    align = "lccc",
    caption = "**Tabela 1** Características dos deputados federais eleitos em 2018."
  )
```

A receita total obtida pelos deputados evangélicos foi comparável aos demais deputados, com ambas as classes atingindo receita média superior a 1 milhão de reais.
Os deputados evangélicos obtiveram, na média, 1.08 milhões de reais (desvio padrão 0.7 milhões, CV 64%) e
os demais deputados 1.12 milhões de reais (desvio padrão 0.7 milhões, CV 60%).
A amplitude das receitas observadas variou entre
R\$ 21648 e R\$ 2507377 entre os deputados evangélicos e
R\$ 12075 e R\$ 2500500 entre os demais (Tabela 1 e Figura 1).

```{r fig1, fig.cap="**Figura 1** Distribuição da receita total dos deputados federais eleitos em 2018."}
# ![Age](../figures/receita_total.png)
knitr::include_graphics("../figures/receita_total.png", error = FALSE)
```

## Determinação de clusters para k-means: elbow plot

```{r fig2, fig.cap="**Figura 2** Elbow plot do método k-means."}
# ![Age](../figures/elbow.png)
knitr::include_graphics("../figures/elbow.png", error = FALSE)
```


Usando k = 3 clusters o WSS total foi `r format.float(km3$tot.withinss)` que explica `r format.pct(pct.km3)` da variância.

Usando k = 2 clusters o WSS total foi `r format.float(km2$tot.withinss)` que explica `r format.pct(pct.km2)` da variância.

## Determinação de clusters para k-means: cluster hierárquico

O agrupamento hierárquico

```{r fig3, fig.cap="**Figura 3** Silhouette plot do cluster hierárquico."}
# ![Age](../figures/silhouette.png)
knitr::include_graphics("../figures/silhouette.png", error = FALSE)
```

```{r silhuetas, eval=FALSE, include=FALSE}
hc4_sil[, 3] %>% summary %>% round(digits = 2)
hc2_sil[, 3] %>% summary %>% round(digits = 2)
```

Estipulando o número ótimo de clusters em k = 4, as silhuetas das observações variam entre -0.28 e 0.66 com média 0.37 e mediana 0.40.
Este número de clusters pode ser identificado cortando o dendrograma na altura h = 2.2 (Figura 4).
Estipulando o número de clusters em k = 2, as silhuetas das observações variam entre -0.38 e 0.67 com média 0.34 e mediana 0.38.

```{r fig4, fig.cap="**Figura 4** Dendrograma do cluster hierárquico, corte na altura h = 2.2."}
# ![Age](../figures/silhouette.png)
knitr::include_graphics("../figures/dendrograma.png", error = FALSE)
```

## Sensibilidade da análise à remoção de variáveis

```{r fig5, fig.cap="**Figura 5** Elbow plot do método k-means com o dataset completo."}
# ![Age](../figures/elbow.png)
knitr::include_graphics("../figures/elbow_full.png", error = FALSE)
```

Usando k = 3 clusters o WSS total foi `r format.float(km3.fd$tot.withinss)` que explica `r format.pct(pct.km3.fd)` da variância.

Usando k = 2 clusters o WSS total foi `r format.float(km2.fd$tot.withinss)` que explica `r format.pct(pct.km2.fd)` da variância.

```{r fig6, fig.cap="**Figura 6** Silhouette plot do cluster hierárquico com o dataset completo."}
# ![Age](../figures/silhouette.png)
knitr::include_graphics("../figures/silhouette_full.png", error = FALSE)
```

```{r fig7, fig.cap="**Figura 7** Dendrograma do cluster hierárquico com o dataset completo, cortes nas alturas h = 3.85 (vermelho) e h = 2.75 (azul)."}
# ![Age](../figures/silhouette.png)
knitr::include_graphics("../figures/dendrograma_full.png", error = FALSE)
```

# Observações e limitações

# Conclusões

O número ótimo de clusters identificado foi k = 4 clusters.
Este número de clusters possibilita identificar dois grupos de evangélicos e dois grupos de não evangélicos com receitas médias diferentes.

# Referências

- **SAP-2021-011-JG-v01** -- Plano Analítico para Clusterização hierárquica para determinação do número ótimo de clusters para classificação de deputados federais como bancada evangélica
<!-- - Cohen, J. (1988). Statistical power analysis for the behavioral sciences (2nd Ed.). New York: Routledge. -->

# Apêndice

## Análise exploratória de dados

```{r A1, fig.cap="**Figura A1** Distribuição das receitas de deputados federais, por origem (agp = receita que veio do Partido ao invés de apoiadores privados (empresariais ou não); agr = setor agrícola; com = setor do comércio; fin = setor específico dos bancos e outras instituições financeiras e imobiliárias; ind = setores da indústria; inf = setor de infraestrutura; pf = pessoa física; rp = recursos próprios; ser = setor de serviços). "}

# ![Age](../figures/receitas.png)
knitr::include_graphics("../figures/receitas.png", error = FALSE)
```

```{r A2, fig.cap="**Figura A2** Elbow plot do método k-means, com o full dataset."}

# ![elbow full](../figures/elbow_full.png)
knitr::include_graphics("../figures/elbow_full.png", error = FALSE)

```

## Disponibilidade

<!-- Tanto este documento como o plano analítico correspondente (**SAP-2021-011-JG-v01**) podem ser obtidos no seguinte endereço: -->

Este documento pode ser obtido no seguinte endereço:

https://github.com/philsf-biostat/SAR-2021-011-JG/

## Dados utilizados

Os dados utilizados neste relatório não podem ser publicados online por questões de sigilo.

```{r data}
# print analytical of analytical_mockup whether it is the private or public version of the SAR

# analytical %>%
#   pander(caption = "**Table A1** Tabela de dados analíticos")
analytical_mockup %>%
  pander(caption = "**Table A1** Estrutura da tabela de dados analíticos")
```
